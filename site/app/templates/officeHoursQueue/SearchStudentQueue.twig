<div id='student_queue_history'>
    <br>
    <h2>Student's Queue History</h2>
    <div id='search-student-queue'>
        <input id='search-student-queue-input' type='text' placeholder="Enter student's name">
        <button id='search-student-queue-btn' class="btn btn-primary">Search</button>
    </div>
    <table id='student-queue-table' class="table table-striped" style="margin-top: 15px;">
        <caption style="padding: 5px; border: 1px solid var(--standard-light-gray); font-weight: 600;"></caption>
        <thead>
            <tr>
                <th scope='col'>#</th>
                <th scope='col'>Current state</th>
                <th scope='col'>Queue</th>
                <th scope='col'>Time Entered</th>
                <th scope='col'>Time In Queue</th>
                <th scope='col'>Time Helped</th>
                <th scope='col'>Help Started By</th>
                <th scope='col'>Removal Type</th>
            </tr>
        </thead>
        <tbody id="search-student-tbody">

        </tbody>
    </table>
</div>

<script>
    const search_student_queue = document.getElementById('search-student-queue-input');
    const search_student_queue_btn = document.getElementById('search-student-queue-btn');
    const table_body = document.getElementById('search-student-tbody');
    const table_caption = document.querySelector('#student-queue-table caption')
    const times_helped_row = document.createElement('tr');
    const times_helped_cell = document.createElement('td');
    times_helped_cell.setAttribute('colspan', '8');
    times_helped_cell.style.backgroundColor = 'var(--standard-vibrant-green)';
    times_helped_row.appendChild(times_helped_cell);
    const url = buildCourseUrl(['queue', 'student_search']);
    search_student_queue_btn.addEventListener('click', event => {
        table_body.innerHTML = '';
        $.ajax({
            url: url,
            type: 'POST',
            data: {
                student_id: search_student_queue.value,
                // eslint-disable-next-line no-undef
                csrf_token: csrfToken
            },
            success: function(response) {
                let i = 0;
                let help_counter = 0;
                const data = JSON.parse(response).data;
                const student_data = JSON.parse(data);
                table_caption.innerHTML = `${student_data[0].name} - (ID:${student_data[0].user_id}) - Contact: ${student_data[0].contact_info}`;
                while (i < student_data.length){
                    const detail_row = document.createElement('tr');
                    let j = i + 1;
                    if (student_data[i].removal_type === 'helped') {
                        help_counter++;
                    }
                    const time_start = student_data[i].time_in;
                    const time_end = student_data[i].time_out === null ? '-' : student_data[i].time_out;
                    const removed_by = student_data[i].removed_by === null ? '-' : student_data[i].removed_by;
                    const helper = student_data[i].help_started_by === null ? '-' : student_data[i].help_started_by;
                    const removal_method = student_data[i].removal_type === null ? '-' : student_data[i].removal_type;
                    detail_row.innerHTML = `
                        <td>${j}</td>
                        <td>${student_data[i].current_state}</td>
                        <td>${student_data[i].queue_code}</td>
                        <td>${time_start}</td>
                        <td>${time_end}</td>
                        <td>${removed_by}</td>
                        <td>${helper}</td>
                        <td>${removal_method}</td>
                    `;
                    table_body.appendChild(detail_row);
                    i++;
                }
                times_helped_cell.innerHTML = help_counter + ' times helped.';
                table_body.appendChild(times_helped_row);
            },
            error: function() {
                window.alert('Something went wrong while searching for students!');
            },
        });
    });
</script>

